# Step06: 支持多订单类型（Limit / IOC / FOK / Market） —— 对齐 Serum DEX 真实撮合逻辑

本阶段目标：为撮合引擎引入与主流 DEX（如 [Serum DEX](https://github.com/project-serum/serum-dex/blob/master/dex/src/state.rs)）一致的多种订单类型支持，包括限价单（Limit）、市价单（Market）、立即成交否则取消（IOC）、全部成交否则取消（FOK）。

---

## 一、为什么要支持多订单类型？

在去中心化交易所和专业撮合系统中，丰富的订单类型是提升用户体验和市场效率的基础。  
Serum DEX 等主流链上撮合器都支持如下订单类型：

- **限价单（Limit）**  
  只在指定价格或更优价格成交，未成交部分可挂在订单簿等待后续撮合。
- **市价单（Market）**  
  以市场当前最优价格尽可能全部成交，未成交部分自动取消，不入订单簿。
- **IOC（Immediate Or Cancel，立即成交否则取消）**  
  能成交多少就成交多少，剩余未成交部分立即取消，不入订单簿。
- **FOK（Fill Or Kill，全部成交否则取消）**  
  只有能一次性全部成交才成交，否则全部取消。

这些订单类型极大丰富了用户的交易策略，也对撮合引擎的精度和性能提出了更高要求。

---

## 二、各类型订单的撮合规则

| 订单类型 | 描述 | 撮合规则 |
|----------|------|-----------------------------|
| Limit    | 限价单 | 按价格撮合，剩余可入簿 |
| Market   | 市价单 | 全部以最优价尽量成交，剩余自动取消 |
| IOC      | 立即成交否则取消 | 能成交多少就成交多少，剩余立即取消 |
| FOK      | 全部成交否则取消 | 只有全部撮合成功才成交，否则全撤销 |

**举例说明**：

- Alice 市价买 10 个，但市场只挂着 5 个卖单 → 只成交 5 个，剩余自动取消
- Bob 限价买 10 个，价格挂高于市场卖单 → 立刻全部成交
- Carol FOK 卖 8 个，只要市场买单不够 8 个 → 直接全部撤销，不成交
- Dave IOC 买 10 个，市场只有 7 个卖单 → 成交 7 个，剩余 3 个自动撤销

---

## 三、对标 Serum DEX 的实现细节

在 Serum DEX 源码 [state.rs → OrderType](https://github.com/project-serum/serum-dex/blob/master/dex/src/state.rs) 中，订单类型通过枚举（OrderType）字段实现，核心撮合逻辑依赖该字段决定“撮合步进-入簿-撤销”等行为。

```rust
pub enum OrderType {
    Limit,    // 限价单
    ImmediateOrCancel, // IOC
    PostOnly, // 只挂单，不吃单（本步不实现，可扩展）
    // ...
}
```

Serum 撮合函数根据 OrderType 判断是否允许部分成交、是否允许订单部分或全部进入订单簿、是否需要全部成交等。

## 四、本阶段实现目标
- 为订单结构体添加 OrderType 字段
- 撮合逻辑支持四种主流订单类型（Limit/Market/IOC/FOK）
- 下单接口支持选择订单类型
- 撮合结果和事件队列准确反映不同订单类型的行为
- 代码结构和命名贴合 Serum DEX 习惯，便于链上迁移